# Implementation Plan: Tooling Modernization

**Branch**: `001-tooling-modernization` | **Date**: 2025-12-08 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-tooling-modernization/spec.md`
**Review Status**: Approved with revisions (2025-12-08)

## Summary

Modernize the OmniFocus MCP Server development infrastructure from legacy npm/tsc
tooling to a modern, unified stack (pnpm, tsup, Vitest, Biome, tsx) to achieve
sub-second build feedback, enhanced type safety, and automated quality gates.
The migration follows a 7-phase approach with explicit validation and rollback
strategies at each boundary.

## Estimated Timeline

| Phase | Estimated Duration | Can Parallelize |
|-------|-------------------|-----------------|
| Phase 1: pnpm | 15-30 minutes | No (foundation) |
| Phase 2: TS strict | 2-4 hours | No |
| Phase 3: tsup | 30-60 minutes | No |
| Phase 4: Biome | 30-60 minutes | Yes (with Phase 5) |
| Phase 5: tsx | 15 minutes | Yes (with Phase 4) |
| Phase 6: Vitest | 30 minutes | No |
| Phase 7: Husky | 15 minutes | No |
| CI Updates | 1-2 hours | No |
| **Total** | **5-9 hours** | |

## Phase Dependency Graph

```text
Phase 1 (pnpm)
    │
    ▼
Phase 2 (TS strict)
    │
    ▼
Phase 3 (tsup)
    │
    ├───────────┬───────────┐
    ▼           ▼           ▼
Phase 4     Phase 5     Phase 6
(Biome)     (tsx)       (Vitest)
    │           │
    ▼           │
Phase 7  ◄──────┘
(Husky)
    │
    ▼
CI Updates
```

## Technical Context

**Language/Version**: TypeScript 5.9+ targeting ES2024
**Primary Dependencies**: @modelcontextprotocol/sdk 1.24.3, Zod 4.1.x
**Storage**: N/A (file-based JXA scripts only)
**Testing**: Vitest (new addition)
**Target Platform**: macOS (Node.js 24.0.0+, OmniFocus 4+)
**Project Type**: Single project (MCP server)
**Performance Goals**: ≤1 second build feedback, ≤3 second lint/format
**Constraints**: Must maintain npm distribution compatibility, JXA scripts unchanged
**Scale/Scope**: 29 TypeScript files, 3 JXA scripts, ~2,500 LOC

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Research Validation

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Type-First Development | ✅ PASS | Enhanced with noUncheckedIndexedAccess, exactOptionalPropertyTypes, verbatimModuleSyntax |
| II. Separation of Concerns | ✅ PASS | Tool architecture unchanged; only build tooling affected |
| III. Script Execution Safety | ✅ PASS | JXA scripts copied unchanged via onSuccess hook |
| IV. Structured Data Contracts | ✅ PASS | Zod schemas remain; no API changes |
| V. Defensive Error Handling | ✅ PASS | No changes to error handling patterns |
| VI. Build Discipline | ✅ PASS | Enhanced: tsup replaces manual copy-files step |
| VII. KISS | ✅ PASS | Single tool per concern (Biome = lint+format) |
| VIII. YAGNI | ✅ PASS | Only implementing spec requirements, no extras |
| IX. SOLID Principles | ✅ PASS | No architectural changes |
| MCP Integration Standards | ✅ PASS | StdioServerTransport, Zod schemas unchanged |

**Gate Status**: PASSED - Proceed with implementation

## Project Structure

### Documentation (this feature)

```text
specs/001-tooling-modernization/
├── plan.md              # This file
├── research.md          # Tool decisions and rationale
├── quickstart.md        # Developer migration guide
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# Existing structure (unchanged)
src/
├── server.ts            # MCP server entry point
├── omnifocustypes.ts    # OmniFocus type definitions
├── types.ts             # General types
├── tools/
│   ├── definitions/     # MCP tool schemas (10 files)
│   └── primitives/      # Business logic (10 files)
└── utils/
    ├── scriptExecution.ts
    ├── dateFormatting.ts
    ├── cacheManager.ts
    ├── secureTempFile.ts
    └── omnifocusScripts/
        ├── omnifocusDump.js
        ├── listPerspectives.js
        └── getPerspectiveView.js

# New test structure
tests/
├── unit/                # Unit tests for primitives
├── integration/         # Integration tests for tools
└── fixtures/            # Test data

# New/modified configuration files
├── tsup.config.ts       # Build configuration (NEW)
├── vitest.config.ts     # Test configuration (NEW)
├── biome.json           # Lint/format configuration (NEW)
├── tsconfig.json        # TypeScript configuration (MODIFIED)
├── package.json         # Package configuration (MODIFIED)
├── pnpm-lock.yaml       # Lock file (REPLACES package-lock.json)
└── .husky/
    └── pre-commit       # Pre-commit hook (NEW)
```

**Structure Decision**: Single project structure. No changes to src/ organization.
Only configuration files and test directory added.

## Implementation Phases

### Phase 1: Package Manager Migration (npm → pnpm)

**Objective**: Establish strict dependency isolation and enable vulnerability auditing

**Prerequisites**: None

**Tasks**:

1. Backup `package-lock.json`
2. Delete `node_modules/` directory
3. Delete `package-lock.json`
4. Run `pnpm import` (converts lock file format)
5. Run `pnpm install`
6. Update `.gitignore`:
   - Add `.pnpm-store/` (pnpm's cache directory)
   - Remove any `package-lock.json` entry if present (should be git-ignored after
     migration)
   - Note: `pnpm-lock.yaml` should be **committed**, not ignored

**Validation**:

- [ ] `pnpm build` succeeds
- [ ] `pnpm start` starts server
- [ ] `pnpm audit` runs without errors
- [ ] No phantom dependency errors

**Rollback**:

```bash
git checkout package-lock.json
rm -rf node_modules pnpm-lock.yaml
npm install
# Verify rollback succeeded:
npm run build && npm run start
```

**Commit Message**: `chore: migrate from npm to pnpm`

**Requirements Addressed**: FR-005, FR-013

---

### Phase 2: TypeScript Strict Mode Enhancement

**Objective**: Enable enhanced type safety options to catch subtle bugs at
compile time

**Prerequisites**: Phase 1 complete

**Approach**: Enable one option at a time, fix all errors, commit, then proceed
to next option. This isolates the impact of each change.

**Pre-Phase Assessment** (recommended):

Run impact analysis before starting to estimate scope:

```bash
# Count noUncheckedIndexedAccess violations
pnpm exec tsc --noEmit --noUncheckedIndexedAccess 2>&1 | grep -c "error TS" || echo "0"

# Count verbatimModuleSyntax violations (mixed imports)
grep -r "import {.*}" src/ --include="*.ts" | grep -v "import type" | wc -l
```

**Tasks**:

**2.1 Enable noUncheckedIndexedAccess**:

1. Add `"noUncheckedIndexedAccess": true` to tsconfig.json
2. Run `pnpm exec tsc --noEmit`
3. Fix all "possibly undefined" errors with type guards
4. Verify build succeeds

**2.2 Enable exactOptionalPropertyTypes**:

1. Add `"exactOptionalPropertyTypes": true` to tsconfig.json
2. Run `pnpm exec tsc --noEmit`
3. Fix optional property type errors
4. Verify build succeeds

**2.3 Enable verbatimModuleSyntax**:

1. Add `"verbatimModuleSyntax": true` to tsconfig.json
2. Run `pnpm exec tsc --noEmit`
3. Convert mixed imports to explicit syntax:

   ```typescript
   // Before:
   import { addProject, AddProjectParams } from '../primitives/addProject.js';

   // After:
   import { addProject, type AddProjectParams } from '../primitives/addProject.js';
   ```

4. Verify build succeeds

**Validation**:

- [ ] `pnpm exec tsc --noEmit` passes with zero errors
- [ ] `pnpm build` produces working dist/
- [ ] Server starts and responds to MCP requests

**Rollback**:

```bash
git checkout tsconfig.json
# Revert any source file changes
```

**Commit Messages**:

- `feat(types): enable noUncheckedIndexedAccess for array safety`
- `feat(types): enable exactOptionalPropertyTypes`
- `feat(types): enable verbatimModuleSyntax for explicit imports`

**Requirements Addressed**: FR-002, FR-003, FR-004

---

### Phase 3: Build Tool Migration (tsc → tsup)

**Objective**: Achieve sub-second build times with dual format output

**Prerequisites**: Phase 2 complete

**Tasks**:

1. Install tsup: `pnpm add -D tsup`

2. Create `tsup.config.ts` with robust error handling:

   ```typescript
   import { defineConfig } from 'tsup';

   export default defineConfig({
     entry: ['src/server.ts'],
     format: ['esm', 'cjs'],
     dts: true,
     clean: true,
     splitting: false,
     sourcemap: true,
     target: 'node24',
     onSuccess: async () => {
       const { cpSync, existsSync, mkdirSync } = await import('fs');
       const srcDir = 'src/utils/omnifocusScripts';
       const destDir = 'dist/utils/omnifocusScripts';

       if (!existsSync(srcDir)) {
         throw new Error(`JXA scripts directory not found: ${srcDir}`);
       }

       mkdirSync(destDir, { recursive: true });
       cpSync(srcDir, destDir, { recursive: true });
       console.log('✅ JXA scripts copied successfully');
     }
   });
   ```

3. Update `package.json` scripts:
   - `"build": "tsup"`
   - Remove `"copy-files"` script

4. Update `package.json` exports:

   ```json
   {
     "main": "./dist/server.cjs",
     "module": "./dist/server.js",
     "types": "./dist/server.d.ts",
     "exports": {
       ".": {
         "import": "./dist/server.js",
         "require": "./dist/server.cjs",
         "types": "./dist/server.d.ts"
       }
     }
   }
   ```

5. **Update `cli.cjs` for Node 24 compatibility**:

   The existing `cli.cjs` uses deprecated flags. Update it:

   ```javascript
   #!/usr/bin/env node
   // cli.cjs
   const path = require('path');
   const childProcess = require('child_process');

   // ESM output (server.js) works with Node 24 without experimental flags
   const serverPath = path.join(__dirname, 'dist', 'server.js');
   childProcess.spawn('node', [serverPath], {
       stdio: 'inherit'
   });
   ```

   **Note**: The `--experimental-modules` flag is deprecated and unnecessary
   for Node 24+. ESM is natively supported.

6. Verify JXA scripts are copied via onSuccess hook

7. Compare dist/ output with previous build

**Validation**:

- [ ] `pnpm build` completes in under 1 second
- [ ] dist/ contains server.js, server.cjs, server.d.ts
- [ ] dist/utils/omnifocusScripts/ contains all JXA files
- [ ] Server starts via both methods:
  - Direct: `node dist/server.js`
  - Via CLI: `./cli.cjs`
- [ ] Declaration files have correct import paths

**Rollback**:

```bash
rm tsup.config.ts
git checkout package.json cli.cjs
pnpm remove tsup
# Verify rollback succeeded:
pnpm build && pnpm start
```

**Commit Message**: `build: migrate from tsc to tsup for faster builds`

**Requirements Addressed**: FR-001, FR-006, FR-007, FR-011

---

### Phase 4: Linting & Formatting (Biome)

**Objective**: Unify linting and formatting into single tool with single config

**Prerequisites**: Phase 3 complete

**Tasks**:

1. Install Biome: `pnpm add -D @biomejs/biome`

2. Create `biome.json` with latest schema and JXA ignore patterns:

   ```json
   {
     "$schema": "https://biomejs.dev/schemas/2.0.0/schema.json",
     "vcs": {
       "enabled": true,
       "clientKind": "git",
       "useIgnoreFile": true
     },
     "files": {
       "ignore": [
         "src/utils/omnifocusScripts/*.js",
         "dist/**",
         "node_modules/**"
       ]
     },
     "organizeImports": { "enabled": true },
     "linter": {
       "enabled": true,
       "rules": {
         "suspicious": { "noExplicitAny": "error" },
         "style": { "noNonNullAssertion": "warn" }
       }
     },
     "formatter": {
       "enabled": true,
       "indentStyle": "space",
       "indentWidth": 2,
       "lineWidth": 100
     }
   }
   ```

   **Note**: JXA scripts have unconventional JavaScript patterns that may
   trigger false positives, so they are excluded from Biome analysis.

3. Run initial format: `pnpm exec biome format --write .`
4. Run initial lint fix: `pnpm exec biome check --write .`
5. Add scripts to `package.json`:

   ```json
   {
     "lint": "biome check .",
     "format": "biome format --write .",
     "check": "biome check --write ."
   }
   ```

6. Remove any ESLint configuration files if present
7. Remove ESLint dependencies if present

**Validation**:

- [ ] `pnpm lint` passes with zero errors
- [ ] `pnpm format` completes in under 3 seconds
- [ ] `pnpm check` runs both lint and format

**Rollback**:

```bash
rm biome.json
git checkout package.json
pnpm remove @biomejs/biome
```

**Commit Message**: `chore: add Biome for unified linting and formatting`

**Requirements Addressed**: FR-009

---

### Phase 5: Development Runner (tsx)

**Objective**: Enable direct TypeScript execution without build step

**Prerequisites**: Phase 3 complete (can run parallel with Phase 4)

**Tasks**:

1. Install tsx: `pnpm add -D tsx`
2. Update `package.json` scripts:

   ```json
   {
     "dev": "tsx watch src/server.ts"
   }
   ```

3. Test development workflow

**Validation**:

- [ ] `pnpm dev` starts server without prior build
- [ ] File changes trigger automatic reload
- [ ] Server responds to MCP requests

**Rollback**:

```bash
git checkout package.json
pnpm remove tsx
```

**Commit Message**: `dx: add tsx for direct TypeScript execution in development`

**Requirements Addressed**: FR-010

---

### Phase 6: Test Framework (Vitest)

**Objective**: Establish automated testing capability with TypeScript support

**Prerequisites**: Phase 3 complete

**Tasks**:

1. Install Vitest and coverage provider:

   ```bash
   pnpm add -D vitest @vitest/coverage-v8
   ```

   **Note**: The `@vitest/coverage-v8` package is required for the
   `coverage.provider: 'v8'` configuration to work.

2. Create `vitest.config.ts`:

   ```typescript
   import { defineConfig } from 'vitest/config';

   export default defineConfig({
     test: {
       include: ['tests/**/*.test.ts'],
       environment: 'node',
       coverage: {
         provider: 'v8',
         reporter: ['text', 'html'],
         exclude: [
           'node_modules/**',
           'dist/**',
           'src/utils/omnifocusScripts/**'
         ]
       }
     }
   });
   ```

3. Create test directory structure:

   ```bash
   mkdir -p tests/unit tests/integration tests/fixtures
   ```

4. Add scripts to `package.json`:

   ```json
   {
     "test": "vitest run",
     "test:watch": "vitest",
     "test:coverage": "vitest run --coverage"
   }
   ```

5. Create sample test file to verify setup:

   ```typescript
   // tests/unit/sample.test.ts
   import { describe, it, expect } from 'vitest';

   describe('Sample Test', () => {
     it('should pass', () => {
       expect(1 + 1).toBe(2);
     });
   });
   ```

**Validation**:

- [ ] `pnpm test` executes and passes
- [ ] TypeScript tests run without compilation step
- [ ] Watch mode (`pnpm test:watch`) works
- [ ] Coverage report generates: `pnpm test:coverage`

**Rollback**:

```bash
rm vitest.config.ts
rm -rf tests/
git checkout package.json
pnpm remove vitest @vitest/coverage-v8
# Verify rollback succeeded:
pnpm build && pnpm start
```

**Commit Message**: `test: add Vitest test framework with TypeScript support`

**Requirements Addressed**: FR-008

---

### Phase 7: Pre-commit Hooks (Husky + lint-staged)

**Objective**: Automate code quality checks before each commit

**Prerequisites**: Phase 4 complete (Biome must be working)

**Tasks**:

1. Install dependencies: `pnpm add -D husky lint-staged`

2. Initialize Husky: `pnpm exec husky init`

3. Add prepare script to `package.json`:

   ```json
   {
     "scripts": {
       "prepare": "husky"
     }
   }
   ```

   **Important**: The `prepare` script runs automatically after `pnpm install`.
   This ensures that when new contributors clone the repo and run
   `pnpm install`, Husky's git hooks are automatically installed. Without
   this, contributors would need to manually run `pnpm exec husky init`.

4. Configure lint-staged in `package.json`:

   ```json
   {
     "lint-staged": {
       "*.{ts,js,json,md}": ["biome check --write --staged"]
     }
   }
   ```

   **Note**: Using `--staged` flag is more efficient as Biome natively
   understands which files are staged.

5. Update `.husky/pre-commit`:

   ```bash
   pnpm exec lint-staged
   ```

6. Test by making a commit

**Validation**:

- [ ] Commit triggers lint-staged
- [ ] Biome runs on staged files
- [ ] Commit succeeds after fixes applied
- [ ] New clone + install auto-installs hooks

**Rollback**:

```bash
rm -rf .husky
git checkout package.json
pnpm remove husky lint-staged
# Verify rollback succeeded:
pnpm build && pnpm start
```

**Commit Message**: `ci: add pre-commit hooks with Husky and lint-staged`

**Requirements Addressed**: FR-012

---

## CI/CD Updates

**Objective**: Update GitHub Actions to use new tooling

**Workflows to Update** (5 total):

| Workflow | File | npm Commands |
|----------|------|--------------|
| CI | `.github/workflows/ci.yml` | npm ci, npm run build, tsc |
| PR Checks | `.github/workflows/pr-checks.yml` | npm ci, npm run build, npm audit |
| Publish | `.github/workflows/publish.yml` | npm ci, npm run build, npm publish |
| CodeQL | `.github/workflows/codeql.yml` | (may use npm, verify) |
| Copilot Setup | `.github/workflows/copilot-setup-steps.yml` | (verify if npm used) |

**Tasks**:

### 1. Common pnpm Setup Pattern

Add to all workflows that use npm:

```yaml
- uses: pnpm/action-setup@v4
  with:
    version: 9

- uses: actions/setup-node@v4
  with:
    node-version: '24'
    cache: 'pnpm'

- run: pnpm install --frozen-lockfile
```

### 2. Update `.github/workflows/ci.yml`

**Changes**:

- Add pnpm setup steps
- Replace `npm ci` → `pnpm install --frozen-lockfile`
- Replace `npm run build` → `pnpm build`
- Replace `npx tsc --noEmit` → `pnpm exec tsc --noEmit`
- Add `pnpm-lock.yaml` to path triggers:

  ```yaml
  paths:
    - 'src/**'
    - 'package.json'
    - 'pnpm-lock.yaml'  # Add this
    - 'tsconfig.json'
  ```

- **Update validate-structure job**: Remove `copy-files` from required scripts:

  ```javascript
  const required = ['build', 'start'];  // Remove 'copy-files'
  ```

### 3. Update `.github/workflows/pr-checks.yml`

**Changes**:

- Add pnpm setup steps
- Replace all `npm` commands with `pnpm` equivalents
- Replace `npm audit` → `pnpm audit`

### 4. Update `.github/workflows/publish.yml`

**Changes**:

- Add pnpm setup steps
- Replace `npm ci` → `pnpm install --frozen-lockfile`
- Replace `npm run build` → `pnpm build`
- **Keep `npm publish`**: npm is used for publishing to npm registry (not pnpm)

### 5. Verify Other Workflows

- Check `codeql.yml` and `copilot-setup-steps.yml` for any npm usage
- Update if necessary

**Validation**:

- [ ] All 5 workflows updated
- [ ] CI workflow passes on PR
- [ ] PR checks workflow passes
- [ ] Publish workflow tested (dry-run if possible)
- [ ] pnpm-lock.yaml triggers CI appropriately
- [ ] validate-structure job no longer requires `copy-files`

**Commit Message**: `ci: update GitHub Actions for pnpm and new tooling`

**Requirements Addressed**: SC-004

---

## Success Criteria Verification

| Criterion | Verification Method | Phase |
|-----------|---------------------|-------|
| SC-001: ≤1s build | Time `pnpm build` execution | 3 |
| SC-002: Direct TS execution | `pnpm dev` starts without build | 5 |
| SC-003: ≤3s lint/format | Time `pnpm check` execution | 4 |
| SC-004: CI speed | Measure GitHub Actions duration before/after | CI |
| SC-005: No ts-ignore | `grep -r "@ts-ignore" src/` returns empty | 2 |
| SC-006: Regression-free | All validation checkpoints pass | All |

**SC-004 Timing Measurement**:

```bash
# Before migration: Record baseline CI duration
gh run list --limit 5 --json durationMs,conclusion

# After migration: Compare new CI duration
gh run list --limit 5 --json durationMs,conclusion
```

---

## Complexity Tracking

No constitution violations requiring justification. All changes are configuration-level
and maintain existing architectural patterns.

---

## Risk Summary

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| TypeScript strict failures | High | Medium | Phase incrementally, commit after each |
| Phantom dependencies | Medium | High | Audit imports before pnpm migration |
| Build output differences | Medium | High | Compare dist/ before/after tsup; verify CLI works |
| Pre-commit hook failures | Low | Low | Run biome check before commit setup |
| CI Runner Node 24 support | Low | Medium | Verify GitHub Actions supports Node 24 |
| npm Registry Publishing | Low | High | Keep `npm publish` (not pnpm); test with `--dry-run` |

---

## Appendix A: Final package.json Scripts

After all phases complete:

```json
{
  "scripts": {
    "build": "tsup",
    "start": "node dist/server.js",
    "dev": "tsx watch src/server.ts",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage",
    "lint": "biome check .",
    "format": "biome format --write .",
    "check": "biome check --write .",
    "prepare": "husky"
  },
  "lint-staged": {
    "*.{ts,js,json,md}": ["biome check --write --staged"]
  }
}
```

---

## Appendix B: Final devDependencies

```json
{
  "devDependencies": {
    "@biomejs/biome": "^2.0.0",
    "@vitest/coverage-v8": "^2.0.0",
    "husky": "^9.0.0",
    "lint-staged": "^15.0.0",
    "tsup": "^8.0.0",
    "tsx": "^4.0.0",
    "typescript": "^5.9.0",
    "vitest": "^2.0.0"
  }
}
```

---

## Appendix C: Review Changes Log

**2025-12-08 - Plan Review Revisions**:

| Issue | Resolution |
|-------|------------|
| CLI wrapper compatibility | Added `cli.cjs` update task in Phase 3; removed deprecated `--experimental-modules` flag |
| Incomplete CI workflow list | Enumerated all 5 workflow files with specific changes for each |
| tsup onSuccess error handling | Replaced shell commands with Node.js `fs` APIs for cross-platform reliability |
| .gitignore updates incorrect | Clarified `.pnpm-store/` should be ignored, `pnpm-lock.yaml` committed |
| Missing @vitest/coverage-v8 | Added as explicit dependency in Phase 6 |
| Outdated Biome schema | Updated to `2.0.0` schema; added JXA ignore patterns |
| Husky prepare not explained | Added explanation of auto-install behavior for contributors |
| Missing timing estimates | Added timeline table and phase dependency graph |
| Missing rollback verification | Added verification commands to all rollback sections |
| CI validate-structure job | Added task to remove `copy-files` from required scripts |
| Biome --staged flag | Added for more efficient pre-commit hook execution |
