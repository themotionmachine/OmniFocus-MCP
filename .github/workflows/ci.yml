name: CI

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - 'tsup.config.ts'
      - 'vitest.config.ts'
      - 'biome.json'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - 'tsup.config.ts'
      - 'vitest.config.ts'
      - 'biome.json'
      - '.github/workflows/ci.yml'

# SECURITY: Restrict permissions to minimum required (least privilege principle)
permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Biome lint
        run: pnpm lint

  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        run: pnpm typecheck

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    env:
      NODE_OPTIONS: --max-old-space-size=4096

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build with tsup
        run: pnpm build

      - name: Verify build artifacts
        run: |
          if [ ! -f "dist/server.js" ]; then
            echo "❌ dist/server.js not found"
            exit 1
          fi

          if [ ! -f "dist/server.cjs" ]; then
            echo "❌ dist/server.cjs not found"
            exit 1
          fi

          if [ ! -f "dist/server.d.ts" ]; then
            echo "❌ dist/server.d.ts not found"
            exit 1
          fi

          echo "✅ Build artifacts verified"

      - name: Verify JXA scripts copied
        run: |
          if [ ! -d "dist/utils/omnifocusScripts" ]; then
            echo "❌ JXA scripts directory not found"
            exit 1
          fi

          if [ ! -f "dist/utils/omnifocusScripts/omnifocusDump.js" ]; then
            echo "❌ omnifocusDump.js not copied"
            exit 1
          fi

          echo "✅ JXA scripts copied successfully"

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify required files
        run: |
          # Check for required source files
          [ -f "src/server.ts" ] || { echo "❌ src/server.ts missing"; exit 1; }
          [ -f "src/omnifocustypes.ts" ] || { echo "❌ src/omnifocustypes.ts missing"; exit 1; }
          [ -d "src/tools" ] || { echo "❌ src/tools directory missing"; exit 1; }
          [ -d "src/utils" ] || { echo "❌ src/utils directory missing"; exit 1; }

          # Check for JXA scripts
          [ -d "src/utils/omnifocusScripts" ] || { echo "❌ JXA scripts directory missing"; exit 1; }
          [ -f "src/utils/omnifocusScripts/omnifocusDump.js" ] || { echo "❌ omnifocusDump.js missing"; exit 1; }

          # Check for required config files
          [ -f "package.json" ] || { echo "❌ package.json missing"; exit 1; }
          [ -f "tsconfig.json" ] || { echo "❌ tsconfig.json missing"; exit 1; }
          [ -f "tsup.config.ts" ] || { echo "❌ tsup.config.ts missing"; exit 1; }
          [ -f "vitest.config.ts" ] || { echo "❌ vitest.config.ts missing"; exit 1; }
          [ -f "biome.json" ] || { echo "❌ biome.json missing"; exit 1; }
          [ -f "CLAUDE.md" ] || { echo "❌ CLAUDE.md missing"; exit 1; }

          echo "✅ All required files present"

      - name: Verify package.json scripts
        run: |
          # Verify required pnpm scripts exist
          node -e "
            const pkg = require('./package.json');
            const required = ['build', 'start', 'dev', 'lint', 'typecheck', 'test'];
            const missing = required.filter(s => !pkg.scripts[s]);
            if (missing.length) {
              console.error('❌ Missing scripts:', missing.join(', '));
              process.exit(1);
            }
            console.log('✅ All required scripts present');
          "

  validate-mcp-schema:
    name: Validate MCP Tool Schemas
    runs-on: ubuntu-latest
    needs: [build]
    env:
      NODE_OPTIONS: --max-old-space-size=4096

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Check for tool definitions
        run: |
          if [ ! -d "src/tools/definitions" ]; then
            echo "❌ Tool definitions directory missing"
            exit 1
          fi

          TOOL_COUNT=$(find src/tools/definitions -name "*.ts" | wc -l)
          echo "Found $TOOL_COUNT tool definition files"

          if [ "$TOOL_COUNT" -lt 1 ]; then
            echo "❌ No tool definitions found"
            exit 1
          fi

          echo "✅ Tool definitions present"
